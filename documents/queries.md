# Query & Mutation Strategy

This document outlines the architecture for data fetching, caching, and optimistic UI updates using oRPC and TanStack Query.

## Goals

1.  **Deduplication**: Never fetch the same data twice per render.
2.  **Scalability**: Centralized logic for keys and cache updates.
3.  **Responsiveness**: Optimistic updates for immediate UI feedback (Local-First feel).
4.  **Type Safety**: End-to-end type safety from DB to UI component.

## Architecture

### 1. The Data Layer (oRPC + TanStack Query)

We use `@orpc/tanstack-query` which provides a bridge between our typed API client and TanStack Query.

-   **Client**: Generated from the shared `appRouter`.
-   **Keys**: Automatically generated by oRPC (e.g., `orpc.tasks.list.key()`).
-   **Caching**: Configured globally via `QueryClient` and per-hook via `staleTime`.

### 2. Date Handling

-   **Backend (API)**:
    -   Service Layer: Uses `Date` objects (Domain Model).
    -   Transport: Encodes `Date` to **ISO Strings** via Effect Schema.
-   **Frontend**:
    -   Receives **ISO Strings**.
    -   Uses `date-fns` to format strings for display.
    -   **Input**: When sending dates back (e.g., `startTime`), use `Date` objects or ISO strings (Schema handles both).

### 3. Pattern: Custom Hooks

We encapsulate query/mutation logic in custom hooks (e.g., `useTasks`) rather than calling `orpc` directly in components.

**Why?**
-   **Shared Optimistic Updates**: Creating a task in the `Sidebar` should optimistically update the `Calendar` view if they share the same underlying query key logic.
-   **Abstraction**: Components don't need to know about cache invalidation details.

### 4. Optimistic Updates Strategy

For mutations (Create, Update, Delete), we follow this pattern:

1.  **`onMutate`**:
    -   Cancel outgoing queries for the target key (e.g., `['tasks', 'list']`).
    -   Snapshot the previous data (for rollback).
    -   **Optimistically update** the cache with the new/modified item.
        -   *Note*: For creation, we generate a temporary ID.
2.  **`onError`**:
    -   Rollback to the snapshot.
    -   Show a toast error.
3.  **`onSettled`**:
    -   Invalidate the query key to ensure eventually consistent data with the server.

## Implementation Checklist

-   [ ] **`apps/web/src/hooks/use-tasks.ts`**:
    -   `useTasks()`: Fetches tasks with `staleTime: 5 * 60 * 1000`.
    -   `useCreateTask()`: Optimistic create.
    -   `useUpdateTask()`: Optimistic update (by ID).
    -   `useDeleteTask()`: Optimistic delete.
-   [ ] **`apps/web/src/components/app-sidebar.tsx`**: Connect to `useTasks`.
-   [ ] **`apps/web/src/components/sidebar-right.tsx`**: (Future) Connect to `useTasks` for calendar view.

